<!DOCTYPE html>
<html>

<head>
	<!--link rel="stylesheet" type="text/css" href="main.css"-->
</head>

<body>
	<div id="app">
		<table id="board">
		</table>
	</div>

	<div id="letters">

	</div>

	<div>
		<button onClick="submit()">Submit</button>
	</div>
	<script src="init.js"></script>
	<script src="style.js"></script>
	<!--script src="main.js"></script-->
	<!--script src="main.js"></script-->

<script>
	let selected_slot_id = null;
	let placed_letters = [];
	let existing_coordinates = [];

	function select_letter(button_id) {
		let slot = document.getElementById(button_id);

		if (slot.innerHTML !== "--") {
			clear_style(selected_slot_id);
			selected_slot_id = button_id;
			set_selected_style(button_id);
		}
	}

	function update_position(button_id) {
		let board_position = document.getElementById(button_id);

		let empty = board_position.innerHTML === "--";
		let letter_selected = selected_slot_id !== null;

		if (empty && letter_selected) {
			place_letter_at(board_position);
			set_placed_style(button_id);
			clear_style(selected_slot_id);
			selected_slot_id = null;

			placed_letters.push(button_id);
		}

		if (!empty && !letter_selected) {
			unplace_letter_at(board_position);
			clear_style(button_id);

			placed_letters = placed_letters.filter(x => x !== button_id);
		}

		if (!empty && letter_selected) {
			swap_letter_at(board_position);
			clear_style(selected_slot_id);
			selected_slot_id = null;
		}
	}

	function place_letter_at(board_position) {
		let slot = document.getElementById(selected_slot_id);
		let letter = slot.innerHTML;

		board_position.innerHTML = letter;
		slot.innerHTML = "--";
	}

	function unplace_letter_at(board_position) {
		let letter = board_position.innerHTML;

		fill_slot(letter);
		board_position.innerHTML = "--";
	}

	function fill_slot(letter) {
		for (i = 0; i < 7; i++) {
			let slot = document.getElementById(i);

			if (slot.innerHTML === "--") {
				slot.innerHTML = letter;
				break;
			}
		}
	}

	function swap_letter_at(board_position) {
		let slot = document.getElementById(selected_slot_id);
		let slot_letter = slot.innerHTML;

		unplace_letter_at(board_position);

		board_position.innerHTML = slot_letter;
		slot.innerHTML = "--";
	}

	function submit() {
		if(placed_letters.length === 0)
			return;

		let coordinates = placed_letters
			.map(x => x.split('-')
				.map(y => parseInt(y)));

		let valid = validate(coordinates);

		console.log(valid);

		if (!valid)
			return;

		let placed_letters_amount = placed_letters.length;

		for (i = 0; i < placed_letters_amount; i++) {
			let id = placed_letters[i];

			set_fixed_style(id);
		}

		let new_letters = get_letters(placed_letters_amount);

		new_letters.forEach(x => fill_slot(x));

		console.log(new_letters);

		existing_coordinates = existing_coordinates.concat(coordinates);

		console.log(existing_coordinates);

		placed_letters = [];

		//pack word into object
		//logic to check validity of words
	}

	function validate(coordinates) {
		let horizontal = coordinates
			.map(x => x[0])
			.every((val, i, arr) => val === arr[0]);

		let vertical = coordinates
			.map(x => x[1])
			.every((val, i, arr) => val === arr[0]);

		if (!(horizontal || vertical))
		{
			console.log("not h or v");		
			return false;
		}

		let common_index = horizontal ? 0 : 1;
		let test_index = Math.abs(1 - common_index);
		let common_entry = coordinates[0][common_index];

		console.log(`common entry ${common_entry}`);

		let entries = coordinates
			.map(x => x[test_index])
			.sort((a,b) => (a-b));

		console.log(`entries ${entries}`);

		let existing_entries = existing_coordinates
			.filter(x => x[common_index] === common_entry)
			.map(x => x[test_index]);

		console.log(`existing ${existing_entries}`);

		let word_vector = get_word_vector(entries, existing_entries);

		console.log(`wv: ${word_vector}`);

		let start_index = get_word_start_index(entries[0], word_vector);

		console.log(`start ${start_index}`);
		let end_index = get_word_end_index(entries[entries.length - 1], word_vector);

		console.log(`end ${end_index}`);

		let sequential = test_sequential(word_vector, start_index, end_index);

		if (!sequential)
		{
			console.log("not sequential");
			return false;
		}

		let sequence = word_vector.slice(start_index, end_index);

		let intersection = sequence.filter(x => existing_entries.includes(x));

		return existing_entries.length === 0 ? true : intersection.length > 0;
	}

	function get_word_vector(entries, existing_entries) {
		let empty_vector = Array.from({ length: 15 }, () => null);

		for(i=0; i<entries.length; i++)
		{
			empty_vector[entries[i]] = entries[i];
		}

		for(i=0; i<existing_entries.length; i++)
		{
			empty_vector[existing_entries[i]] = existing_entries[i];
		}

		return empty_vector;
	}

	function test_sequential(arr, start, stop) {
		console.log(`arr ${arr}`);

		for (i=start; i<=stop; i++) {
			if (arr[i] === null)
				return false;
		}
		return true;
	}

	function get_word_start_index(start, word_vector) {
		if (start === 0)
			return 0;

		

		for (i=start; i>0; i--) {
			let preceding_entry = word_vector[i - 1];
				
			if(preceding_entry === null)
				return i;

			if(i === 1)
				return 0;
		}
	}

	function get_word_end_index(start, word_vector) {
		if (start === 14)
			return 14;

		for (i = start; i < 14; i++) {
			let next_entry = word_vector[i + 1];

			if (next_entry === null)
				return i;

			if(i === 13)
				return 14;
		}
	}


	draw_board();

	fill_slots();
</script>
</body>

</html>
